<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ø­Ø±Ø± ÙŠØ§Ù…Ø§</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/loader.min.js"></script>
    <style>
        body { margin: 0; padding: 0; display: flex; height: 100vh; background: #0a0a0a; color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #left-side { flex: 1; display: flex; flex-direction: column; min-width: 0; position: relative; }
        #editor-container { flex: 1; min-height: 0; }
        #h-resizer { height: 6px; cursor: row-resize; background: #222; border-top: 1px solid gold; }
        #preview-area { height: 200px; background: #fff; color: #000; padding: 15px; overflow: auto; position: relative; font-family: monospace; }
        #preview-area::before { content: "Ù…Ø®Ø±Ø¬Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"; position: absolute; top: 0; left: 0; background: gold; color: black; font-size: 11px; padding: 2px 8px; font-weight: bold; }
        #sidebar { width: 260px; background: #111; display: flex; flex-direction: column; gap: 10px; border-left: 1px solid #333; padding: 15px; box-sizing: border-box; }
        #resizer { width: 5px; cursor: col-resize; background: #222; }
        .section-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; padding-bottom: 5px; }
        .icon-btn { background: none; border: 1px solid #444; color: gold; cursor: pointer; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
        #file-list { display: flex; flex-direction: column; gap: 4px; overflow-y: auto; flex-grow: 1; }
        .file-item { background: #1a1a1a; padding: 8px; border: 1px solid #333; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .file-item.active { border-color: gold; }
        .file-item input { background: transparent; border: none; color: gold; width: 70%; outline: none; }
        #error-log { color: #ff6b6b; font-size: 12px; padding: 10px; background: #1a0000; display: none; }

        /* Ø³ØªØ§ÙŠÙ„ ØµÙØ­Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ù†ÙØµÙ„Ø© */
        #file-manager-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; display: none; flex-direction: column; padding: 50px; box-sizing: border-box; direction: rtl; }
        .fm-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px; overflow-y: auto; margin-top: 20px; }
        .fm-card { background: #1a1a1a; padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #333; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø¯Ø®Ù„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø§Ø´Ø© */
        .yama-input { display: block; width: 90%; border: none; border-bottom: 2px solid gold; background: transparent; outline: none; margin-top: 5px; font-family: monospace; }
    </style>
</head>
<body>

    <div id="file-manager-overlay">
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid gold; padding-bottom: 20px;">
            <h1 style="margin:0;">ğŸ“ Ø§Ù„Ù…Ù„ÙØ§Øª</h1>
            <div>
                <button class="icon-btn" style="font-size: 20px;" onclick="document.getElementById('device-upload').click()">+</button>
                <button class="icon-btn" onclick="toggleFileManager()">Ø¥ØºÙ„Ø§Ù‚ âœ–</button>
            </div>
        </div>
        <input type="file" id="device-upload" style="display: none;" onchange="handleDeviceUpload(this)">
        <div id="fm-grid" class="fm-grid"></div>
    </div>

    <div id="left-side">
        <div id="editor-container"></div>
        <div id="error-log"></div>
        <div id="h-resizer"></div>
        <div id="preview-area"></div>
    </div>

    <div id="resizer"></div>

    <div id="sidebar">
        <div class="section-header">
            <div class="header-controls">
                <button onclick="addNewFile()" class="icon-btn">+</button>
                <button id="run-stop-btn" onclick="toggleRun()" class="icon-btn">â–¶</button>
            </div>
            <h2 style="color: gold; font-size: 0.8rem; margin: 0;">Ø§Ù„Ø³ÙƒØ±ÙŠØ¨ØªØ§Øª</h2>
        </div>
        <div id="file-list"></div>

        <button onclick="toggleFileManager()" class="icon-btn" style="width: 100%; padding: 10px; margin-top: 10px;">ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²</button>

        <div style="font-size: 10px; color: #666; text-align: center; margin-top: auto; padding-top: 10px; border-top: 1px solid #222;">
            Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­Ø±Ø± Ù…Ø®ØµØµ Ù„Ù„ØªØ¯Ø±ÙŠØ¨ Ø¯ÙˆÙ† Ø§Ù„Ù†Ø´Ø±<br>
            <span style="color: #444;">Ù…Ø­Ø±Ùƒ ÙŠØ§Ù…Ø§  ğŸš€</span>
        </div>
    </div>

    <script>
        var editor;
        var files = JSON.parse(localStorage.getItem('yama_files')) || [{name: 'main.yama', content: 'Ù…ØªØºÙŠØ± Ø§Ø³Ù… = Ø§Ø·Ù„Ø¨("Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù…ÙƒØŸ");\nØ§Ø·Ø¨Ø¹("Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙŠØ§ " + Ø§Ø³Ù…);'}];
        var deviceFiles = JSON.parse(localStorage.getItem('yama_device_files')) || [];
        var activeFileIdx = 0;

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ø·Ù„Ø¨ ÙˆØ§Ø·Ø¨Ø¹
        function loadCloudRules() {
            const cloudURL = "https://raw.githubusercontent.com/st425gf-source/yama-editor/main/rules.js";
            fetch(cloudURL)
                .then(r => r.text())
                .then(code => {
                    eval(code); 
                    console.log("Ù‚ÙˆØ§Ø¹Ø¯ ÙŠØ§Ù…Ø§ Ø¬Ø§Ù‡Ø²Ø©");
                })
                .catch(e => {
                    // Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ Ø§Ù„Ø³Ø­Ø§Ø¨
                    window.Ø§Ø·Ø¨Ø¹ = function(txt) {
                        const area = document.getElementById('preview-area');
                        area.innerHTML += `<div><b>â†</b> ${txt}</div>`;
                        area.scrollTop = area.scrollHeight;
                    };
                    window.Ø§Ø·Ù„Ø¨ = function(q) {
                        return new Promise(resolve => {
                            const area = document.getElementById('preview-area');
                            const div = document.createElement('div');
                            div.innerHTML = `<div><b>${q}</b></div>`;
                            const input = document.createElement('input');
                            input.className = 'yama-input';
                            div.appendChild(input);
                            area.appendChild(div);
                            input.focus();
                            input.onkeydown = (e) => { if(e.key === 'Enter') { 
                                const val = input.value;
                                div.innerHTML = `<div>${q}</div><div style="color:gold">> ${val}</div>`;
                                resolve(val); 
                            }};
                        });
                    };
                });
        }
        loadCloudRules();

        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            editor = monaco.editor.create(document.getElementById('editor-container'), {
                value: files[activeFileIdx].content, language: 'javascript', theme: 'vs-dark', fontSize: 16, automaticLayout: true
            });
            editor.onDidChangeModelContent(() => { files[activeFileIdx].content = editor.getValue(); saveFiles(); });
            renderFiles();
        });

        function toggleFileManager() {
            const overlay = document.getElementById('file-manager-overlay');
            overlay.style.display = overlay.style.display === 'flex' ? 'none' : 'flex';
            renderDeviceFiles();
        }

        function handleDeviceUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                deviceFiles.push({ name: file.name, size: (file.size / 1024).toFixed(1) + " KB" });
                saveDeviceFiles();
                renderDeviceFiles();
            }
        }

        function renderDeviceFiles() {
            const grid = document.getElementById('fm-grid');
            grid.innerHTML = '';
            deviceFiles.forEach((file, idx) => {
                const card = document.createElement('div');
                card.className = 'fm-card';
                card.innerHTML = `
                    <div style="font-size: 30px;">ğŸ“„</div>
                    <input type="text" value="${file.name}" onchange="renameDeviceFile(${idx}, this.value)" style="background:none; border:none; color:gold; text-align:center; width:100%; margin-top:5px;">
                    <div style="color:#666; font-size:10px;">${file.size}</div>
                    <div onclick="deleteDeviceFile(${idx})" style="color:red; cursor:pointer; font-size:12px; margin-top:10px;">Ø­Ø°Ù ğŸ—‘</div>
                `;
                grid.appendChild(card);
            });
        }

        function deleteDeviceFile(idx) { deviceFiles.splice(idx, 1); saveDeviceFiles(); renderDeviceFiles(); }
        function renameDeviceFile(idx, newName) { deviceFiles[idx].name = newName; saveDeviceFiles(); }
        function saveDeviceFiles() { localStorage.setItem('yama_device_files', JSON.stringify(deviceFiles)); }

        // --- Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù„Ø¯Ø¹Ù… Ø§Ø·Ù„Ø¨ ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª ---
        async function toggleRun() {
            document.getElementById('preview-area').innerHTML = "";
            document.getElementById('error-log').style.display = 'none';
            
            let rawCode = editor.getValue();
            // ØªØ±Ø¬Ù…Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
            let cleanCode = rawCode
                .replace(/Ù…ØªØºÙŠØ±\s+/g, "var ")
                .replace(/(?<!await\s)Ø§Ø·Ù„Ø¨/g, "await Ø§Ø·Ù„Ø¨");

            try { 
                // Ø§Ù„ØªÙ†ÙÙŠØ° Ø¯Ø§Ø®Ù„ Ø¯Ø§Ù„Ø© async ÙÙˆØ±ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                const AsyncFunction = Object.getPrototypeOf(async function(){}).constructor;
                const runner = new AsyncFunction('Ø§Ø·Ø¨Ø¹', 'Ø§Ø·Ù„Ø¨', cleanCode);
                await runner(window.Ø§Ø·Ø¨Ø¹, window.Ø§Ø·Ù„Ø¨);
            } catch(e) { 
                const log = document.getElementById('error-log');
                log.style.display = 'block';
                log.innerText = "âš ï¸ Ø®Ø·Ø£: " + e.message;
            }
        }

        function renderFiles() {
            const list = document.getElementById('file-list');
            list.innerHTML = '';
            files.forEach((file, idx) => {
                const item = document.createElement('div');
                item.className = `file-item ${idx === activeFileIdx ? 'active' : ''}`;
                item.onclick = () => { activeFileIdx = idx; editor.setValue(files[idx].content); renderFiles(); };
                item.innerHTML = `<input type="text" value="${file.name}" onchange="renameFile(${idx}, this.value)"><button onclick="deleteFile(${idx}, event)" style="background:none; border:none; color:red; cursor:pointer;">Ã—</button>`;
                list.appendChild(item);
            });
        }

        function addNewFile() { files.push({name: "script" + (files.length+1) + ".yama", content: ""}); saveFiles(); renderFiles(); }
        function deleteFile(idx, e) { e.stopPropagation(); if(files.length > 1) { files.splice(idx, 1); activeFileIdx = 0; editor.setValue(files[0].content); saveFiles(); renderFiles(); } }
        function renameFile(idx, newName) { files[idx].name = newName; saveFiles(); }
        function saveFiles() { localStorage.setItem('yama_files', JSON.stringify(files)); }

        const resizer = document.getElementById('resizer');
        let isResizing = false;
        resizer.addEventListener('mousedown', () => isResizing = true);
        document.addEventListener('mousemove', (e) => {
            if (isResizing) { document.getElementById('sidebar').style.width = (window.innerWidth - e.clientX) + 'px'; editor.layout(); }
        });
        document.addEventListener('mouseup', () => isResizing = false);
    </script>
</body>
</html>
